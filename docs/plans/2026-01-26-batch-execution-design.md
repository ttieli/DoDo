# 批量执行功能设计

日期：2026-01-26

## 概述

为 DoDo 添加批量执行能力，支持对多个输入执行同一个命令或 API 请求。

## 设计目标

- 命令（Action）和 API 都支持批量
- 输入来源：手动多行输入 / 选择文件夹
- 并行执行，实时显示进度
- 失败项标记，不影响其他项继续执行
- **非批量时界面保持不变**

## 数据模型

### BatchItem

```swift
struct BatchItem: Identifiable {
    var id: UUID
    var input: String              // 输入路径/URL/参数值
    var output: String?            // 输出路径（命令）或 JSON 文件路径（API）
    var status: BatchItemStatus    // pending/running/success/failed
    var result: String?            // 输出内容或错误信息
    var response: APIResponse?     // API 响应（仅 API 批量）
    var startedAt: Date?
    var finishedAt: Date?
}

enum BatchItemStatus: String {
    case pending    // 等待中
    case running    // 执行中
    case success    // 成功
    case failed     // 失败
}
```

### BatchExecution

```swift
@MainActor
class BatchExecution: ObservableObject {
    @Published var items: [BatchItem] = []
    @Published var isRunning = false
    @Published var completedCount = 0
    @Published var failedCount = 0

    let maxConcurrency = 3  // 默认并发数
}
```

不持久化，批量执行是一次性操作。

## UI 设计

### 输入区域

现有输入框保持不变，右侧加菜单按钮：

```
┌─────────────────────────────────┬───┐
│ /path/to/file.pdf               │ ⋮ │
└─────────────────────────────────┴───┘
```

点击「⋮」弹出菜单：
- 选择文件夹（批量）
- 多行输入（批量）

### 批量模式输入

```
┌─────────────────────────────────┬───┐
│ 批量模式 (3 项)            [退出] │ ⋮ │
├─────────────────────────────────┴───┤
│ /path/file1.pdf                     │
│ /path/file2.pdf                     │
│ /path/file3.pdf                     │
│ + 添加更多...                        │
└─────────────────────────────────────┘
```

执行按钮文案变为「批量执行 (3)」

### 命令批量 - 输出配置

```
┌─────────────────────────────────────┐
│ 输出目录: ○ 同输入目录  ● 指定目录   │
│ ┌─────────────────────────────┬───┐ │
│ │ /Users/xx/output            │ 📁│ │
│ └─────────────────────────────┴───┘ │
└─────────────────────────────────────┘
```

文件命名：保留原文件名，改扩展名，重名加序号。

### 命令批量 - 执行结果

执行中：

```
┌─────────────────────────────────────┐
│ 批量执行中 (2/3)                     │
├─────────────────────────────────────┤
│ ✓ file1.pdf → file1.md         1.2s │
│ ◐ file2.pdf                   执行中 │
│ ○ file3.pdf                   等待中 │
└─────────────────────────────────────┘
```

执行完成：

```
┌─────────────────────────────────────┐
│ 完成 ✓2 ✗1                          │
├─────────────────────────────────────┤
│ ✓ file1.pdf → file1.md         1.2s │
│ ✓ file2.pdf → file2.md         0.8s │
│ ✗ file3.pdf  解析失败：文件损坏      │
└─────────────────────────────────────┘
```

点击某项可展开查看详细输出。

### API 批量 - 输入配置

指定批量变量：

```
┌─────────────────────────────────────┐
│ 批量变量: [company ▼]               │
├─────────────────────────────────────┤
│ 腾讯                                 │
│ 阿里巴巴                             │
│ 字节跳动                             │
└─────────────────────────────────────┘
```

### API 批量 - 结果展示

外层列表（可切换查看）：

```
┌─────────────────────────────────────┐
│ 完成 ✓3                      [导出] │
├─────────────────────────────────────┤
│ ● 腾讯                         1.2s │
│ ○ 阿里巴巴                     0.8s │
│ ○ 字节跳动                     0.9s │
└─────────────────────────────────────┘
```

内层复用单条响应视图：

```
┌─────────────────────────────────────┐
│ [JSON] [卡片/表格]                   │
├─────────────────────────────────────┤
│  （和单条请求完全一致的视图）         │
└─────────────────────────────────────┘
```

### API 批量 - 导出

点击「导出」选择目录，每个请求保存为独立 JSON：
- `腾讯.json`
- `阿里巴巴.json`
- `字节跳动.json`

## 执行逻辑

### 并行控制

- 默认并发数：3
- 使用 Swift TaskGroup 控制并发
- 暂不提供 UI 配置

### 错误处理

- 单项失败不影响其他项
- 失败项记录错误信息
- 最终显示成功/失败统计

### 命令输出命名

1. 取输入文件名（不含扩展名）
2. 加上输出格式对应的扩展名
3. 如有重名，加序号（-1, -2, ...）

## 文件变更

### 新增文件

| 文件 | 说明 |
|------|------|
| `Models/BatchExecution.swift` | 批量执行状态模型 |
| `Services/BatchRunner.swift` | 批量执行器（命令+API） |
| `Views/Common/BatchInputView.swift` | 批量输入组件 |
| `Views/Common/BatchResultView.swift` | 批量结果列表组件 |

### 修改文件

| 文件 | 说明 |
|------|------|
| `Views/Main/ActionDetailView.swift` | 集成批量输入和结果展示 |
| `Views/API/APIEndpointDetailView.swift` | 集成批量输入和结果展示 |

## 后续扩展（暂不实现）

- 从 CSV/JSON 文件读取输入列表
- 从上一步 API 结果提取列表
- 可配置并发数
- 批量执行历史记录
